(this["webpackJsonplearn-cesium"]=this["webpackJsonplearn-cesium"]||[]).push([[20],{146:function(t,e,i){"use strict";i.r(e);var a=i(10),s=i.n(a),n=i(13),r=i(14),h=i(16),o=i(26),d=i(27),u=i(15),c=i(100),l=i(313),_=i.n(l),g={defaults:{useEntitiesIfAvailable:!0,minCanvasSize:700,maxCanvasSize:2e3,radiusFactor:60,spacingFactor:1.5,maxOpacity:.8,minOpacity:.1,blur:.85,gradient:{".3":"green",".65":"yellow",".8":"orange",".95":"rgba(255,0,0,.2)"}},create:function(t,e,i){return new p(t,e,i)},_getContainer:function(t,e,i){var a=document.createElement("div");return i&&a.setAttribute("id",i),a.setAttribute("style","width: "+t+"px; height: "+e+"px; margin: 0px; display: none;"),document.body.appendChild(a),a},_getImageryProvider:function(t){var e=t._heatmap.getDataURL(),i=new c.b.SingleTileImageryProvider({url:e,rectangle:t._rectangle});return i._tilingScheme=new c.b.WebMercatorTilingScheme({rectangleSouthwestInMeters:new c.b.Cartesian2(t._mbounds.west,t._mbounds.south),rectangleNortheastInMeters:new c.b.Cartesian2(t._mbounds.east,t._mbounds.north)}),i},_getID:function(t){for(var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",a=0;a<(t||8);a++)e+=i.charAt(Math.floor(Math.random()*i.length));return e}},f=new c.b.WebMercatorProjection;function p(t,e,i){if(!e)return null;i||(i={}),this._cesium=t,this._options=i,this._id=g._getID(),this._options.gradient=this._options.gradient?this._options.gradient:g.defaults.gradient,this._options.maxOpacity=this._options.maxOpacity?this._options.maxOpacity:g.defaults.maxOpacity,this._options.minOpacity=this._options.minOpacity?this._options.minOpacity:g.defaults.minOpacity,this._options.blur=this._options.blur?this._options.blur:g.defaults.blur,this._mbounds=g.wgs84ToMercatorBB(e),this._setWidthAndHeight(this._mbounds),this._options.radius=Math.round(this._options.radius?this._options.radius:this.width>this.height?this.width/g.defaults.radiusFactor:this.height/g.defaults.radiusFactor),this._spacing=this._options.radius*g.defaults.spacingFactor,this._xoffset=this._mbounds.west,this._yoffset=this._mbounds.south,this.width=Math.round(this.width+2*this._spacing),this.height=Math.round(this.height+2*this._spacing),this._mbounds.west-=this._spacing*this._factor,this._mbounds.east+=this._spacing*this._factor,this._mbounds.south-=this._spacing*this._factor,this._mbounds.north+=this._spacing*this._factor,this.bounds=g.mercatorToWgs84BB(this._mbounds),this._rectangle=c.b.Rectangle.fromDegrees(this.bounds.west,this.bounds.south,this.bounds.east,this.bounds.north),this._container=g._getContainer(this.width,this.height,this._id),this._options.container=this._container,this._heatmap=_.a.create(this._options),this._container.children[0].setAttribute("id",this._id+"-hm")}g.wgs84ToMercator=function(t){var e=f.project(c.b.Cartographic.fromDegrees(t.x,t.y));return{x:e.x,y:e.y}},g.wgs84ToMercatorBB=function(t){var e=f.project(c.b.Cartographic.fromDegrees(t.west,t.south)),i=f.project(c.b.Cartographic.fromDegrees(t.east,t.north));return{north:i.y,east:i.x,south:e.y,west:e.x}},g.mercatorToWgs84=function(t){var e=f.unproject(new c.b.Cartesian3(t.x,t.y));return{x:e.longitude,y:e.latitude}},g.mercatorToWgs84BB=function(t){var e=f.unproject(new c.b.Cartesian3(t.west,t.south)),i=f.unproject(new c.b.Cartesian3(t.east,t.north));return{north:this.rad2deg(i.latitude),east:this.rad2deg(i.longitude),south:this.rad2deg(e.latitude),west:this.rad2deg(e.longitude)}},g.deg2rad=function(t){return t*(Math.PI/180)},g.rad2deg=function(t){return t/(Math.PI/180)},p.prototype.wgs84PointToHeatmapPoint=function(t){return this.mercatorPointToHeatmapPoint(g.wgs84ToMercator(t))},p.prototype.mercatorPointToHeatmapPoint=function(t){var e={};return e.x=Math.round((t.x-this._xoffset)/this._factor+this._spacing),e.y=Math.round((t.y-this._yoffset)/this._factor+this._spacing),e.y=this.height-e.y,e},p.prototype._setWidthAndHeight=function(t){this.width=t.east>0&&t.west<0?t.east+Math.abs(t.west):Math.abs(t.east-t.west),this.height=t.north>0&&t.south<0?t.north+Math.abs(t.south):Math.abs(t.north-t.south),this._factor=1,this.width>this.height&&this.width>g.defaults.maxCanvasSize?(this._factor=this.width/g.defaults.maxCanvasSize,this.height/this._factor<g.defaults.minCanvasSize&&(this._factor=this.height/g.defaults.minCanvasSize)):this.height>this.width&&this.height>g.defaults.maxCanvasSize?(this._factor=this.height/g.defaults.maxCanvasSize,this.width/this._factor<g.defaults.minCanvasSize&&(this._factor=this.width/g.defaults.minCanvasSize)):this.width<this.height&&this.width<g.defaults.minCanvasSize?(this._factor=this.width/g.defaults.minCanvasSize,this.height/this._factor>g.defaults.maxCanvasSize&&(this._factor=this.height/g.defaults.maxCanvasSize)):this.height<this.width&&this.height<g.defaults.minCanvasSize&&(this._factor=this.height/g.defaults.minCanvasSize,this.width/this._factor>g.defaults.maxCanvasSize&&(this._factor=this.width/g.defaults.maxCanvasSize)),this.width=this.width/this._factor,this.height=this.height/this._factor},p.prototype.setData=function(t,e,i){return!!(i&&i.length>0&&null!==t&&!1!==t&&null!==e&&!1!==e)&&(this._heatmap.setData({min:t,max:e,data:i}),this.updateLayer(),!0)},p.prototype.setWGS84Data=function(t,e,i){if(i&&i.length>0&&null!==t&&!1!==t&&null!==e&&!1!==e){for(var a=[],s=0;s<i.length;s++){var n=i[s],r=this.wgs84PointToHeatmapPoint(n);(n.value||0===n.value)&&(r.value=n.value),a.push(r)}return this.setData(t,e,a)}return!1},p.prototype.show=function(t){this._layer&&(this._layer.show=t)},p.prototype.updateLayer=function(){if(g.defaults.useEntitiesIfAvailable&&this._cesium.entities){this._layer&&this._cesium.entities.remove(this._layer);var t=new c.b.ImageMaterialProperty({image:this._heatmap._renderer.canvas});c.b.VERSION>="1.21"?t.transparent=!0:c.b.VERSION>="1.16"&&(t.alpha=.99),this._layer=this._cesium.entities.add({show:!0,rectangle:{coordinates:this._rectangle,material:t,classificationType:c.b.ClassificationType.CESIUM_3D_TILE}})}else this._layer&&this._cesium.scene.imageryLayers.remove(this._layer),this._layer=this._cesium.scene.imageryLayers.addImageryProvider(g._getImageryProvider(this))};var m=g,v=i(106),y=i(34),w=function(t){Object(o.a)(i,t);var e=Object(d.a)(i);function i(){return Object(r.a)(this,i),e.apply(this,arguments)}return Object(h.a)(i,[{key:"componentDidMount",value:function(){var t=Object(n.a)(s.a.mark((function t(){var e,i,a,n,r,h,o,d;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return(e=new c.b.Viewer("stage")).scene.debugShowFramesPerSecond=!0,e.scene.postProcessStages.fxaa.enabled=!0,i=new c.b.Cesium3DTileset({url:v.a+"/shanghai/tileset.json"}),t.next=6,i.readyPromise;case 6:a=t.sent,e.scene.primitives.add(a),e.screenSpaceEventHandler.setInputAction((function(t){var i=e.scene.pickPosition(t.position);if(i){var a=c.b.Cartographic.fromCartesian(i);console.log(c.b.Math.toDegrees(a.longitude)),console.log(c.b.Math.toDegrees(a.latitude))}}),c.b.ScreenSpaceEventType.LEFT_CLICK),n=a.boundingSphere.radius,a.boundingSphere.radius>1e4&&(n=a.boundingSphere.radius/10),e.zoomTo(a,new c.b.HeadingPitchRange(0,-.5,n)),r=e.screenSpaceEventHandler.getInputAction(c.b.ScreenSpaceEventType.LEFT_CLICK),e.screenSpaceEventHandler.setInputAction((function(t){console.log(e.scene.pick(t.position)),r(t)}),c.b.ScreenSpaceEventType.LEFT_CLICK),h={west:121.2,east:121.6,south:30.2,north:31.26},o=m.create(e,h,{radius:40}),d=[{x:121.49532705453251,y:31.240605851735456,value:99}],0,100,o.setWGS84Data(0,100,d);case 20:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}()},{key:"render",value:function(){return Object(y.jsx)("div",{id:"stage"})}}]),i}(u.Component);e.default=w},313:function(t,e,i){var a,s,n;n=function(){var t={defaultRadius:40,defaultRenderer:"canvas2d",defaultGradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},defaultMaxOpacity:1,defaultMinOpacity:0,defaultBlur:.85,defaultXField:"x",defaultYField:"y",defaultValueField:"value",plugins:{}},e=function(){var e=function(t){this._coordinator={},this._data=[],this._radi=[],this._min=10,this._max=1,this._xField=t.xField||t.defaultXField,this._yField=t.yField||t.defaultYField,this._valueField=t.valueField||t.defaultValueField,t.radius&&(this._cfgRadius=t.radius)},i=t.defaultRadius;return e.prototype={_organiseData:function(t,e){var a=t[this._xField],s=t[this._yField],n=this._radi,r=this._data,h=this._max,o=this._min,d=t[this._valueField]||1,u=t.radius||this._cfgRadius||i;r[a]||(r[a]=[],n[a]=[]),r[a][s]?r[a][s]+=d:(r[a][s]=d,n[a][s]=u);var c=r[a][s];return c>h?(e?this.setDataMax(c):this._max=c,!1):c<o?(e?this.setDataMin(c):this._min=c,!1):{x:a,y:s,value:d,radius:u,min:o,max:h}},_unOrganizeData:function(){var t=[],e=this._data,i=this._radi;for(var a in e)for(var s in e[a])t.push({x:a,y:s,radius:i[a][s],value:e[a][s]});return{min:this._min,max:this._max,data:t}},_onExtremaChange:function(){this._coordinator.emit("extremachange",{min:this._min,max:this._max})},addData:function(){if(arguments[0].length>0)for(var t=arguments[0],e=t.length;e--;)this.addData.call(this,t[e]);else{var i=this._organiseData(arguments[0],!0);i&&(0===this._data.length&&(this._min=this._max=i.value),this._coordinator.emit("renderpartial",{min:this._min,max:this._max,data:[i]}))}return this},setData:function(t){var e=t.data,i=e.length;this._data=[],this._radi=[];for(var a=0;a<i;a++)this._organiseData(e[a],!1);return this._max=t.max,this._min=t.min||0,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},removeData:function(){},setDataMax:function(t){return this._max=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setDataMin:function(t){return this._min=t,this._onExtremaChange(),this._coordinator.emit("renderall",this._getInternalData()),this},setCoordinator:function(t){this._coordinator=t},_getInternalData:function(){return{max:this._max,min:this._min,data:this._data,radi:this._radi}},getData:function(){return this._unOrganizeData()}},e}(),i=function(){var t=function(t){var e=t.gradient||t.defaultGradient,i=document.createElement("canvas"),a=i.getContext("2d");i.width=256,i.height=1;var s=a.createLinearGradient(0,0,256,1);for(var n in e)s.addColorStop(n,e[n]);return a.fillStyle=s,a.fillRect(0,0,256,1),a.getImageData(0,0,256,1).data},e=function(t,e){var i=document.createElement("canvas"),a=i.getContext("2d"),s=t,n=t;if(i.width=i.height=2*t,1==e)a.beginPath(),a.arc(s,n,t,0,2*Math.PI,!1),a.fillStyle="rgba(0,0,0,1)",a.fill();else{var r=a.createRadialGradient(s,n,t*e,s,n,t);r.addColorStop(0,"rgba(0,0,0,1)"),r.addColorStop(1,"rgba(0,0,0,0)"),a.fillStyle=r,a.fillRect(0,0,2*t,2*t)}return i};function i(e){var i=e.container,a=this.shadowCanvas=document.createElement("canvas"),s=this.canvas=e.canvas||document.createElement("canvas"),n=(this._renderBoundaries=[1e4,1e4,0,0],getComputedStyle(e.container)||{});s.className="heatmap-canvas",this._width=s.width=a.width=e.width||+n.width.replace(/px/,""),this._height=s.height=a.height=e.height||+n.height.replace(/px/,""),this.shadowCtx=a.getContext("2d"),this.ctx=s.getContext("2d"),s.style.cssText=a.style.cssText="position:absolute;left:0;top:0;",i.style.position="relative",i.appendChild(s),this._palette=t(e),this._templates={},this._setStyles(e)}return i.prototype={renderPartial:function(t){t.data.length>0&&(this._drawAlpha(t),this._colorize())},renderAll:function(t){this._clear(),t.data.length>0&&(this._drawAlpha(function(t){for(var e=[],i=t.min,a=t.max,s=t.radi,n=(t=t.data,Object.keys(t)),r=n.length;r--;)for(var h=n[r],o=Object.keys(t[h]),d=o.length;d--;){var u=o[d],c=t[h][u],l=s[h][u];e.push({x:h,y:u,value:c,radius:l})}return{min:i,max:a,data:e}}(t)),this._colorize())},_updateGradient:function(e){this._palette=t(e)},updateConfig:function(t){t.gradient&&this._updateGradient(t),this._setStyles(t)},setDimensions:function(t,e){this._width=t,this._height=e,this.canvas.width=this.shadowCanvas.width=t,this.canvas.height=this.shadowCanvas.height=e},_clear:function(){this.shadowCtx.clearRect(0,0,this._width,this._height),this.ctx.clearRect(0,0,this._width,this._height)},_setStyles:function(t){this._blur=0==t.blur?0:t.blur||t.defaultBlur,t.backgroundColor&&(this.canvas.style.backgroundColor=t.backgroundColor),this._width=this.canvas.width=this.shadowCanvas.width=t.width||this._width,this._height=this.canvas.height=this.shadowCanvas.height=t.height||this._height,this._opacity=255*(t.opacity||0),this._maxOpacity=255*(t.maxOpacity||t.defaultMaxOpacity),this._minOpacity=255*(t.minOpacity||t.defaultMinOpacity),this._useGradientOpacity=!!t.useGradientOpacity},_drawAlpha:function(t){for(var i=this._min=t.min,a=this._max=t.max,s=(t=t.data||[]).length,n=1-this._blur;s--;){var r,h=t[s],o=h.x,d=h.y,u=h.radius,c=Math.min(h.value,a),l=o-u,_=d-u,g=this.shadowCtx;this._templates[u]?r=this._templates[u]:this._templates[u]=r=e(u,n);var f=(c-i)/(a-i);g.globalAlpha=f<.01?.01:f,g.drawImage(r,l,_),l<this._renderBoundaries[0]&&(this._renderBoundaries[0]=l),_<this._renderBoundaries[1]&&(this._renderBoundaries[1]=_),l+2*u>this._renderBoundaries[2]&&(this._renderBoundaries[2]=l+2*u),_+2*u>this._renderBoundaries[3]&&(this._renderBoundaries[3]=_+2*u)}},_colorize:function(){var t=this._renderBoundaries[0],e=this._renderBoundaries[1],i=this._renderBoundaries[2]-t,a=this._renderBoundaries[3]-e,s=this._width,n=this._height,r=this._opacity,h=this._maxOpacity,o=this._minOpacity,d=this._useGradientOpacity;t<0&&(t=0),e<0&&(e=0),t+i>s&&(i=s-t),e+a>n&&(a=n-e);for(var u=this.shadowCtx.getImageData(t,e,i,a),c=u.data,l=c.length,_=this._palette,g=3;g<l;g+=4){var f,p=c[g],m=4*p;m&&(f=r>0?r:p<h?p<o?o:p:h,c[g-3]=_[m],c[g-2]=_[m+1],c[g-1]=_[m+2],c[g]=d?_[m+3]:f)}this.ctx.putImageData(u,t,e),this._renderBoundaries=[1e3,1e3,0,0]},getValueAt:function(t){var e=this.shadowCtx.getImageData(t.x,t.y,1,1).data[3],i=this._max,a=this._min;return Math.abs(i-a)*(e/255)>>0},getDataURL:function(){return this.canvas.toDataURL()}},i}(),a=function(){var e=!1;return"canvas2d"===t.defaultRenderer&&(e=i),e}(),s=function(){for(var t={},e=arguments.length,i=0;i<e;i++){var a=arguments[i];for(var s in a)t[s]=a[s]}return t},n=function(){var i=function(){function t(){this.cStore={}}return t.prototype={on:function(t,e,i){var a=this.cStore;a[t]||(a[t]=[]),a[t].push((function(t){return e.call(i,t)}))},emit:function(t,e){var i=this.cStore;if(i[t])for(var a=i[t].length,s=0;s<a;s++)(0,i[t][s])(e)}},t}(),n=function(t){var e=t._renderer,i=t._coordinator,a=t._store;i.on("renderpartial",e.renderPartial,e),i.on("renderall",e.renderAll,e),i.on("extremachange",(function(e){t._config.onExtremaChange&&t._config.onExtremaChange({min:e.min,max:e.max,gradient:t._config.gradient||t._config.defaultGradient})})),a.setCoordinator(i)};function r(){var r=this._config=s(t,arguments[0]||{});if(this._coordinator=new i,r.plugin){var h=r.plugin;if(!t.plugins[h])throw new Error("Plugin '"+h+"' not found. Maybe it was not registered.");var o=t.plugins[h];this._renderer=new o.renderer(r),this._store=new o.store(r)}else this._renderer=new a(r),this._store=new e(r);n(this)}return r.prototype={addData:function(){return this._store.addData.apply(this._store,arguments),this},removeData:function(){return this._store.removeData&&this._store.removeData.apply(this._store,arguments),this},setData:function(){return this._store.setData.apply(this._store,arguments),this},setDataMax:function(){return this._store.setDataMax.apply(this._store,arguments),this},setDataMin:function(){return this._store.setDataMin.apply(this._store,arguments),this},configure:function(t){return this._config=s(this._config,t),this._renderer.updateConfig(this._config),this._coordinator.emit("renderall",this._store._getInternalData()),this},repaint:function(){return this._coordinator.emit("renderall",this._store._getInternalData()),this},getData:function(){return this._store.getData()},getDataURL:function(){return this._renderer.getDataURL()},getValueAt:function(t){return this._store.getValueAt?this._store.getValueAt(t):this._renderer.getValueAt?this._renderer.getValueAt(t):null}},r}();return{create:function(t){return new n(t)},register:function(e,i){t.plugins[e]=i}}},t.exports?t.exports=n():void 0===(s="function"===typeof(a=n)?a.call(e,i,e,t):a)||(t.exports=s)}}]);